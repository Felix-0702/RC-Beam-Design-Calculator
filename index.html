<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RC Section Design Report Generator (HK CoP 2013) - v6.2 AI Enhanced</title>
    <style>
        /* * Professional Engineering Report Stylesheet v6.2
         * - Added functionality to select AI provider and use custom API endpoints.
         * - Refined AI design recommendation output to be more brief and use numbered lists.
         * - Corrected shear calculation to align with HK CoP 2013 Table 6.3.
         * - Implemented AI-powered overview generation and rephrasing.
         * - Refined UI with accordions and interactive elements.
         */
        :root {
            --primary-color: #0d47a1; /* Professional blue */
            --secondary-color: #f1f5f9; /* Light grey background */
            --border-color: #cbd5e1; /* Softer grey for borders */
            --text-color: #1e293b;
            --header-bg: #e2e8f0;
            --success-color: #16a34a;
            --danger-color: #dc2626;
            --warning-color: #f59e0b;
            --info-color: #3b82f6;
        }

        body {
            font-family: 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            margin: 0;
            background-color: #f8fafc;
            font-size: 14px;
        }

        .main-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            max-width: 1800px;
            padding: 20px;
            margin: auto;
        }

        .inputs-panel {
            flex: 1.5;
            min-width: 450px;
            padding: 20px;
            border-radius: 8px;
            background-color: #fff;
            border: 1px solid var(--border-color);
            align-self: flex-start;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .report-panel {
            flex: 2;
            min-width: 800px;
        }

        .page-container {
            width: 210mm;
            margin: 0 auto 20px auto;
            padding: 15mm;
            background: white;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            box-sizing: border-box;
            position: relative;
        }

        h1, h2, h3, h4 {
            color: var(--primary-color);
            margin-top: 0;
            font-weight: 600;
        }
        
        h1 {
            text-align: center;
            border-bottom: none;
            margin-bottom: 20px;
            font-size: 1.8rem;
        }

        h2 { 
            margin-top: 15px; 
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 6px;
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        h3 {
             margin-top: 10px; 
             border-bottom: 1px solid #94a3b8;
             padding-bottom: 4px;
             font-size: 1.1rem;
             font-weight: bold;
        }

        h4 {
            font-size: 1rem;
            color: #334155;
            border-bottom: none;
        }
        
        /* Accordion Styles */
        details {
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 10px;
            background-color: var(--secondary-color);
        }
        details[open] {
            background-color: #fff;
        }
        summary {
            font-weight: 600;
            cursor: pointer;
            padding: 12px;
            list-style: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        summary::-webkit-details-marker { display: none; }
        summary::after {
            content: '+';
            font-size: 1.5em;
            color: var(--primary-color);
            transition: transform 0.2s;
        }
        details[open] summary::after {
            content: '−';
        }
        .accordion-content {
            padding: 0 15px 15px 15px;
        }

        .input-group { margin-bottom: 16px; }
        .input-group.checkbox-group { display: flex; align-items: center; }
        .input-group.checkbox-group input { width: auto; margin-right: 10px; }

        label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.9rem; }
        label .convention { font-weight: normal; font-style: italic; color: #475569; font-size: 0.8rem; }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1rem;
        }
        
        .rebar-table input, .rebar-table select, #load-case-table input {
            padding: 4px;
            font-size: 0.9rem;
            border: 1px solid #e2e8f0;
        }
        #load-case-table th { font-size: 0.8rem; }

        .rebar-table td:first-child { font-weight: bold; text-align: center; }
        
        textarea#spreadsheet-data { min-height: 150px; font-family: monospace; font-size: 0.9rem; }

        button {
            width: 100%;
            padding: 12px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
            transition: background-color 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            filter: brightness(1.1);
        }

        button.table-button, button.ai-button {
             background-color: var(--info-color);
             font-size: 14px;
             padding: 8px;
             margin-top: 4px;
        }
        
        .table-button-group, .ai-button-group { display: flex; gap: 10px; }
        
        button.remove-layer-btn {
            background-color: var(--danger-color);
            width: auto;
            padding: 5px 10px;
            font-size: 12px;
            margin-top: 0;
            border-radius: 50%;
            line-height: 1;
        }
        
        #print-btn { background-color: var(--success-color); }
        #reset-btn { background-color: var(--danger-color); }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        th, td { border: 1px solid var(--border-color); padding: 6px 8px; text-align: left; vertical-align: middle; }
        th { background-color: var(--header-bg); font-weight: 600; }
        tr:nth-child(even) { background-color: #f8fafc; }
        
        #load-case-summary tbody tr { cursor: pointer; }
        #load-case-summary tbody tr:hover { background-color: #e3f2fd; }
        #load-case-summary tbody tr.critical { background-color: #fffbe6; font-weight: bold; }
        
        .utilization-bar {
            width: 100%;
            height: 10px;
            background-color: #e2e8f0;
            border-radius: 5px;
            overflow: hidden;
        }
        .utilization-bar-inner {
            height: 100%;
            border-radius: 5px;
            transition: width 0.3s;
        }

        .citation { font-size: 0.8em; color: #0ea5e9; font-weight: bold; margin-left: 10px; font-style: italic; }

        .design-summary-container { display: grid; grid-template-columns: 1.5fr 1fr; gap: 20px; align-items: flex-start; }
        .summary-card-container { display: flex; flex-direction: column; gap: 15px; }
        .summary-card { border: 1px solid var(--border-color); border-radius: 6px; padding: 10px 15px; height: 100%; box-sizing: border-box; }
        .summary-card p { margin: 6px 0; }

        .final-rebar { font-weight: bold; color: #c2410c; }
        .check-ok { color: var(--success-color); font-weight: bold; }
        .check-fail { color: var(--danger-color); font-weight: bold; }

        .beam-sketch { text-align: center; max-width: 350px; margin: auto; }
        .beam-sketch svg { border: 1px solid var(--border-color); width: 100%; height: auto; background-color: #fff; }
        .beam-sketch h3 { font-size: 14px; margin-top: 10px; border: none; color: var(--text-color); }
        
        .report-header { display: grid; grid-template-columns: 1.2fr 4fr; border: 2px solid black; margin-bottom: 15px; }
        .report-header .logo-container { border-right: 2px solid black; display: flex; align-items: center; justify-content: center; padding: 5px; min-height: 80px; }
        .report-header .logo-container img { max-width: 120px; max-height: 80px; object-fit: contain; }
        .report-header .right-content { display: grid; grid-template-rows: 1fr 1fr; }
        .report-header .title-container { border-bottom: 2px solid black; text-align: center; padding: 5px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .report-header .title-container h2 { font-size: 18px; font-weight: bold; border: none; padding: 0; margin: 0; }
        .report-header .title-container h3 { font-size: 16px; font-weight: bold; border: none; padding: 0; margin: 0; }
        .report-header .info-container { display: grid; grid-template-columns: repeat(3, 1fr); }
        .report-header .info-cell { padding: 5px 10px; border-left: 2px solid black; font-size: 12px; }
        .report-header .info-cell:first-child { border-left: none; }
        .report-header .info-cell p { margin: 2px 0; }
        .report-header .info-cell span { font-weight: bold; }
        
        #recommendation-section {
            display: none;
            margin-top: 20px;
            padding: 15px;
            border: 1px solid var(--warning-color);
            background-color: #fffbe6;
            border-radius: 8px;
        }
         #recommendation-section h3 {
             color: #d97706; /* Darker warning color */
             border-bottom-color: #f59e0b;
             margin-top: 0;
        }
        #recommendation-output { white-space: pre-wrap; font-family: monospace; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 600px; }
        .modal-content textarea { height: 200px; }
        
        .version-notes { margin-top: 20px; padding: 10px; font-size: 0.8rem; color: #01579b; background-color: #e3f2fd; border-radius: 4px; border: 1px solid #90caf9; }

        /* Print-specific styles */
        @media print {
            body { background-color: #fff; font-size: 12px; line-height: 1.4; }
            .main-container { display: block; padding: 0; }
            .inputs-panel, .ai-button { display: none !important; }
            .report-panel { width: 100%; }
            .page-container { width: calc(100% - 50px); box-shadow: none; border: none; margin: 20px 20px 20px 30px; padding: 0; page-break-after: always; }
            .page-container:last-child { page-break-after: auto; }
            h2, h3 { page-break-after: avoid; margin-top: 10px; padding-bottom: 4px; }
            h2 { font-size: 16px; }
            h3 { font-size: 14px; }
            table { font-size: 11px; margin-top: 8px; }
            th, td { padding: 4px 5px; }
            .summary-card p { margin: 5px 0; }
            .design-summary-container, .section-with-diagram { gap: 15px; }
            .beam-sketch { max-width: 280px; }
            table, .design-summary-container, .section-with-diagram, #load-case-summary { page-break-inside: avoid; }
            #recommendation-section { display: none !important; } /* Hide AI section in print */
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="inputs-panel">
            <h1>RC Section Design Inputs (v6.2)</h1>
            
            <details open>
                <summary>Batch Load Case Input</summary>
                <div class="accordion-content">
                    <small class="convention">Sign Convention: N (+Comp, -Ten), M (+Hog, -Sag)</small>
                    <div class="input-group">
                        <table id="load-case-table">
                            <thead>
                                <tr>
                                    <th>Case</th><th>N</th><th>Vy</th><th>Vx</th><th>M</th><th>T</th><th>M_sls</th><th>N_sls</th><th></th>
                                </tr>
                            </thead>
                            <tbody id="load-case-tbody"></tbody>
                        </table>
                        <div class="table-button-group">
                            <button type="button" class="table-button" id="add-load-case-btn">Add Row</button>
                            <button type="button" class="table-button" id="paste-data-btn">Paste from Spreadsheet</button>
                        </div>
                    </div>
                </div>
            </details>

            <details>
                <summary>Material Properties</summary>
                <div class="accordion-content">
                    <div class="input-group">
                        <label for="fcu">Concrete Grade, fcu (N/mm²)</label>
                        <select id="fcu"><option value="35" selected>C35/45</option><option value="20">C20/25</option><option value="25">C25/30</option><option value="30">C30/37</option><option value="40">C40/50</option><option value="45">C45/55</option><option value="50">C50/60</option></select>
                    </div>
                    <div class="input-group">
                        <label for="fy">Rebar Grade, fy (N/mm²)</label>
                        <select id="fy"><option value="500">500B</option><option value="250">250</option></select>
                    </div>
                </div>
            </details>
            
            <details>
                <summary>Beam & Rebar Detailing</summary>
                <div class="accordion-content">
                     <div class="input-group">
                        <label for="supportCondition">Support Condition</label>
                        <select id="supportCondition"><option value="simply-supported" selected>Simply Supported</option><option value="continuous">Continuous</option><option value="cantilever">Cantilever</option></select>
                    </div>
                    <div class="input-group"><label for="span">Span Length (m)</label><input type="number" id="span" value="5"></div>
                    <div class="input-group"><label for="b">Beam Width, b (mm)</label><input type="number" id="b" value="250"></div>
                    <div class="input-group"><label for="h">Beam Height, h (mm)</label><input type="number" id="h" value="450"></div>
                    <div class="input-group"><label for="c_nom">Nominal Cover, c<sub>nom</sub> (mm)</label><input type="number" id="c_nom" value="35"></div>
                    <div class="input-group"><label>Top Reinforcement</label><table class="rebar-table"><thead><tr><th>Layer</th><th>No.</th><th>Dia.</th><th>Spacing (mm)</th><th></th></tr></thead><tbody id="top-layers-container"></tbody></table><button type="button" class="table-button" id="add-top-layer-btn">Add Top Layer</button></div>
                    <div class="input-group"><label>Bottom Reinforcement</label><table class="rebar-table"><thead><tr><th>Layer</th><th>No.</th><th>Dia.</th><th>Spacing (mm)</th><th></th></tr></thead><tbody id="bottom-layers-container"></tbody></table><button type="button" class="table-button" id="add-bottom-layer-btn">Add Bottom Layer</button></div>
                    <div class="input-group"><label for="aggSize">Nominal Max Aggregate Size (mm)</label><input type="number" id="aggSize" value="20"></div>
                    <div class="input-group"><label for="linkDia">Shear Link Diameter (mm)</label><select id="linkDia"><option value="8">8</option><option value="10" selected>10</option><option value="12">12</option><option value="16">16</option><option value="25">25</option><option value="32">32</option><option value="40">40</option></select></div>
                    <div class="input-group"><label for="numLinkLegs">Number of Shear Link Legs</label><input type="number" id="numLinkLegs" value="2"></div>
                    <div class="input-group"><label for="linkSpacing">Shear Link Spacing (mm)</label><input type="number" id="linkSpacing" value="200"></div>
                    <div class="input-group"><label for="restraintFactor">Restraint Factor, R</label><input type="number" id="restraintFactor" value="0.5"></div>
                    <div class="input-group"><label for="tempDrop">Temperature Drop, T1 (°C)</label><input type="number" id="tempDrop" value="30"></div>
                </div>
            </details>
            
            <details>
                <summary>Report Details & AI Assistant</summary>
                <div class="accordion-content">
                     <div class="input-group"><label for="designerName">Designer</label><input type="text" id="designerName" value="C.E."></div>
                     <div class="input-group"><label for="checkedBy">Checked By</label><input type="text" id="checkedBy" value="S.E."></div>
                     <div class="input-group"><label for="projectTitle">Project Title</label><input type="text" id="projectTitle" value="Example Project"></div>
                     <div class="input-group"><label for="projectSubTitle">Sub-title</label><input type="text" id="projectSubTitle" value="RC Beam Section Design"></div>
                     <div class="input-group"><label for="reportDate">Date</label><input type="date" id="reportDate"></div>
                     <div class="input-group"><label for="reportRevision">Revision</label><input type="text" id="reportRevision" value="A"></div>
                     <div class="input-group"><label for="companyLogo">Company Logo</label><input type="file" id="companyLogo" accept="image/*"></div>
                     <div class="input-group checkbox-group"><input type="checkbox" id="includeOverview" checked><label for="includeOverview">Include Overview Section</label></div>
                     <div id="ai-overview-controls" class="input-group">
                         <label for="ai-overview-text">AI Overview Assistant</label>
                         <textarea id="ai-overview-text" placeholder="Write notes here to rephrase, or click 'Generate' to create from scratch."></textarea>
                         <div class="ai-button-group">
                            <button id="generate-overview-btn" class="ai-button">✨ Generate</button>
                            <button id="rephrase-overview-btn" class="ai-button">✍️ Rephrase</button>
                         </div>
                     </div>
                     <details>
                        <summary>Advanced AI Settings</summary>
                        <div class="accordion-content">
                            <div class="input-group">
                                <label for="aiProvider">AI Provider</label>
                                <select id="aiProvider">
                                    <option value="gemini" selected>Google Gemini</option>
                                    <option value="custom">Custom</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label for="apiUrl">API URL</label>
                                <input type="text" id="apiUrl" placeholder="e.g., https://api.openai.com/v1/chat/completions">
                            </div>
                            <div class="input-group">
                                <label for="apiKey">API Key</label>
                                <input type="password" id="apiKey" placeholder="Enter your API key here">
                            </div>
                        </div>
                    </details>
                </div>
            </details>
            
            <div id="recommendation-section">
                <h3>💡 AI Design Recommendation</h3>
                <div id="recommendation-output"></div>
                <button id="ai-recommend-btn" class="ai-button">Get another suggestion</button>
            </div>

            <button id="calc-btn">Analyze & Verify Design</button>
            <div class="table-button-group">
                <button id="print-btn">Print to PDF</button>
                <button id="reset-btn">Reset to Defaults</button>
            </div>
            
            <div class="version-notes">
                <strong>Notes on V6.2 Update:</strong>
                <ul>
                    <li>Added functionality to select AI provider and use custom API endpoints.</li>
                    <li>Refined AI design recommendation output to be more brief and use numbered lists.</li>
                    <li>Corrected shear capacity calculation (v<sub>c</sub>) to strictly follow HK CoP 2013 Table 6.3.</li>
                    <li>Implemented fully functional AI for design recommendations and report overview generation.</li>
                </ul>
            </div>
        </div>

        <div class="report-panel" id="output-section"></div>
    </div>

    <div id="paste-modal" class="modal-overlay" style="display:none;">
        <div class="modal-content">
            <h3>Paste from Spreadsheet</h3>
            <p>Paste your data below. Data should be tab-separated (copied from Excel/Sheets) and have the following columns: Case, N, Vy, Vx, M, T, M_sls, N_sls.</p>
            <textarea id="spreadsheet-data"></textarea>
            <div class="table-button-group">
                <button type="button" id="process-paste-btn" class="table-button">Process Data</button>
                <button type="button" id="cancel-paste-btn" class="table-button" style="background-color: var(--danger-color);">Cancel</button>
            </div>
        </div>
    </div>
    
    <script>
        // --- Global Variables ---
        document.getElementById('reportDate').valueAsDate = new Date();
        const barData = { 6: 28.3, 8: 50.3, 10: 78.5, 12: 113.1, 16: 201.1, 20: 314.2, 25: 490.9, 32: 804.3, 40: 1256.6, 50: 1963.5 };
        let allResults = []; // Store all calculation results here
        let lastCriticalCase = {}; // Store the last critical case for AI functions
        
        // --- UI & Helper Functions ---
        
        function generateRebarSVG(bottomBars, topBars, inputs, cover, padding, linkDia) {
            const svgWidth = 500;
            const svgHeight = 600;
            const textPadding = 60; // Increased padding for text
            const scale = Math.min((svgWidth - 2 * textPadding) / inputs.b, (svgHeight - 2 * textPadding) / inputs.h);
            
            const beamWidth = inputs.b * scale;
            const beamHeight = inputs.h * scale;
            const xOffset = textPadding + (svgWidth - 2 * textPadding - beamWidth) / 2;
            const yOffset = textPadding + (svgHeight - 2 * textPadding - beamHeight) / 2;

            let svgString = `<svg viewBox="0 0 ${svgWidth} ${svgHeight}" xmlns="http://www.w3.org/2000/svg" style="width:100%; height:auto;">`;
            svgString += `<defs><marker id="axis-arrow" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse"><path d="M 0 0 L 10 5 L 0 10 z" fill="#333" /></marker></defs>`;
            
            // Draw Beam and Link
            svgString += `<rect x="${xOffset}" y="${yOffset}" width="${beamWidth}" height="${beamHeight}" fill="#f0f0f0" stroke="#333" stroke-width="2"/>`;
            svgString += `<rect x="${xOffset + cover*scale}" y="${yOffset + cover*scale}" width="${beamWidth - 2*cover*scale}" height="${beamHeight - 2*cover*scale}" fill="none" stroke="#d9534f" stroke-width="2" rx="${linkDia*scale}" ry="${linkDia*scale}"/>`;
            
            // Draw Bottom Bars
            bottomBars.layers.forEach((layer) => {
                const layerWidth = beamWidth - (2 * cover * scale) - (2 * linkDia * scale) - (layer.dia * scale);
                const spacing = layer.num > 1 ? layerWidth / (layer.num - 1) : 0;
                for (let i = 0; i < layer.num; i++) {
                    const cx = xOffset + cover*scale + linkDia*scale + (layer.dia*scale / 2) + (i * spacing);
                    const cy = yOffset + beamHeight - (layer.depthFromBottom * scale);
                    svgString += `<circle cx="${cx}" cy="${cy}" r="${layer.dia * scale / 2}" fill="#333" />`;
                }
            });

            // Draw Top Bars
            topBars.layers.forEach((layer) => {
                const layerWidth = beamWidth - (2 * cover * scale) - (2 * linkDia * scale) - (layer.dia * scale);
                const spacing = layer.num > 1 ? layerWidth / (layer.num - 1) : 0;
                for (let i = 0; i < layer.num; i++) {
                    const cx = xOffset + cover*scale + linkDia*scale + (layer.dia*scale / 2) + (i * spacing);
                    const cy = yOffset + layer.depth * scale;
                    svgString += `<circle cx="${cx}" cy="${cy}" r="${layer.dia * scale / 2}" fill="#666" />`;
                }
            });

            const midX_viewbox = svgWidth / 2;
            const midY_viewbox = svgHeight / 2;
            // Coordinate Axes (Fixed size and position)
            svgString += `<line x1="${midX_viewbox}" y1="${midY_viewbox + 60}" x2="${midX_viewbox}" y2="${midY_viewbox - 60}" stroke="#0d47a1" stroke-width="1.5" marker-end="url(#axis-arrow)" /><text x="${midX_viewbox + 8}" y="${midY_viewbox - 65}" font-size="24" fill="#0d47a1" font-weight="bold">Y</text>`;
            svgString += `<line x1="${midX_viewbox - 60}" y1="${midY_viewbox}" x2="${midX_viewbox + 60}" y2="${midY_viewbox}" stroke="#0d47a1" stroke-width="1.5" marker-end="url(#axis-arrow)" /><text x="${midX_viewbox + 68}" y="${midY_viewbox + 5}" font-size="24" fill="#0d47a1" font-weight="bold">X</text>`;
            
            // Dimension Lines (Fixed position and size)
            svgString += `<line x1="${xOffset}" y1="30" x2="${xOffset + beamWidth}" y2="30" stroke="#333" stroke-width="1.5" marker-start="url(#axis-arrow)" marker-end="url(#axis-arrow)"/><text x="${xOffset + beamWidth / 2}" y="20" text-anchor="middle" font-size="24" font-family="monospace">b = ${inputs.b}</text>`;
            svgString += `<line x1="30" y1="${yOffset}" x2="30" y2="${yOffset + beamHeight}" stroke="#333" stroke-width="1.5" marker-start="url(#axis-arrow)" marker-end="url(#axis-arrow)"/><text x="20" y="${yOffset + beamHeight / 2}" text-anchor="middle" transform="rotate(-90, 20, ${yOffset + beamHeight/2})" font-size="24" font-family="monospace">h = ${inputs.h}</text>`;
            
            svgString += `</svg>`;
            return svgString;
        }

        function addLayer(type) {
            const container = document.getElementById(`${type}-layers-container`);
            const newRow = container.insertRow();
            const layerNum = container.rows.length;

            newRow.innerHTML = `
                <td>${layerNum}</td>
                <td><input type="number" class="num-bars" value="${layerNum === 1 ? (type === 'top' ? 2 : 3) : 2}"></td>
                <td><select class="bar-dia">
                        <option value="8">8</option><option value="10">10</option><option value="12">12</option><option value="16" ${layerNum === 1 && type==='top' ? 'selected' : ''}>16</option><option value="20">20</option><option value="25" ${layerNum === 1 && type==='bottom' ? 'selected' : ''}>25</option><option value="32">32</option><option value="40">40</option><option value="50">50</option>
                    </select></td>
                <td>${layerNum > 1 ? '<input type="number" class="clear-spacing" value="25">' : 'N/A'}</td>
                <td><button type="button" class="remove-layer-btn">X</button></td>
            `;
        }
        
        function addLoadCaseRow(data = []) {
            const tableBody = document.getElementById('load-case-tbody');
            const newRow = tableBody.insertRow();
            newRow.innerHTML = `
                <td><input type="text" value="${data[0] || ''}"></td>
                <td><input type="number" value="${data[1] || 0}"></td>
                <td><input type="number" value="${data[2] || 0}"></td>
                <td><input type="number" value="${data[3] || 0}"></td>
                <td><input type="number" value="${data[4] || 0}"></td>
                <td><input type="number" value="${data[5] || 0}"></td>
                <td><input type="number" value="${data[6] || 0}"></td>
                <td><input type="number" value="${data[7] || 0}"></td>
                <td><button type="button" class="remove-layer-btn">X</button></td>
            `;
        }
        
        function showPasteModal() { document.getElementById('paste-modal').style.display = 'flex'; }
        function hidePasteModal() { document.getElementById('paste-modal').style.display = 'none'; }

        function processPastedData() {
            const data = document.getElementById('spreadsheet-data').value;
            const lines = data.trim().split('\n');
            const tableBody = document.getElementById('load-case-tbody');
            tableBody.innerHTML = ''; // Clear existing rows

            lines.forEach(line => {
                const parts = line.split(/[\s,;\t]+/); // Use a flexible regex for splitting
                if (parts.length > 0 && parts[0] !== "") {
                    addLoadCaseRow(parts);
                }
            });
            hidePasteModal();
            runBatchAnalysis(); // Trigger analysis once after all rows are added
        }

        // --- Core Calculation & Report Generation ---
        
        function calculate(loadCase, baseInputs, rebarInputs) {
            const inputs = { ...baseInputs, ...loadCase };
            
            const isHogging = inputs.M >= 0;
            const c_nom = inputs.c_nom;
            
            // Calculate centroids and total areas
            let totalTopArea = 0, momentOfTopArea = 0, numTopBars = 0;
            let currentTopDepth = c_nom + inputs.linkDia;
            rebarInputs.topLayers.forEach((layer, index) => {
                if(index > 0) {
                    const prevLayer = rebarInputs.topLayers[index-1];
                    const spacing = Math.max(layer.spacing, prevLayer.dia, inputs.aggSize + 5, 20);
                    currentTopDepth += prevLayer.dia / 2 + spacing + layer.dia / 2;
                } else {
                    currentTopDepth += layer.dia / 2;
                }
                layer.depth = currentTopDepth;
                totalTopArea += layer.area;
                momentOfTopArea += layer.area * layer.depth;
                numTopBars += layer.num;
            });

            let totalBottomArea = 0, momentOfBottomArea = 0, numBottomBars = 0;
            let currentBottomDepth = c_nom + inputs.linkDia;
             rebarInputs.bottomLayers.forEach((layer, index) => {
                if(index > 0) {
                    const prevLayer = rebarInputs.bottomLayers[index-1];
                    const spacing = Math.max(layer.spacing, prevLayer.dia, inputs.aggSize + 5, 20);
                    currentBottomDepth += prevLayer.dia / 2 + spacing + layer.dia / 2;
                } else {
                    currentBottomDepth += layer.dia / 2;
                }
                layer.depthFromBottom = currentBottomDepth;
                totalBottomArea += layer.area;
                momentOfBottomArea += layer.area * layer.depthFromBottom;
                numBottomBars += layer.num;
            });
            
            const d_top_centroid = totalTopArea > 0 ? momentOfTopArea / totalTopArea : 0;
            const d_bottom_centroid_from_bottom = totalBottomArea > 0 ? momentOfBottomArea / totalBottomArea : 0;
            
            const d_y = isHogging ? (inputs.h - d_top_centroid) : (inputs.h - d_bottom_centroid_from_bottom);
            const d_prime = isHogging ? d_bottom_centroid_from_bottom : d_top_centroid;

            const topBars = { num: numTopBars, dia: rebarInputs.topLayers[0]?.dia || 0, area: totalTopArea, layers: rebarInputs.topLayers };
            const bottomBars = { num: numBottomBars, dia: rebarInputs.bottomLayers[0]?.dia || 0, area: totalBottomArea, layers: rebarInputs.bottomLayers };
            const tensionRebar = isHogging ? topBars : bottomBars;
            const compressionRebar = isHogging ? bottomBars : topBars;
            const As_prov = tensionRebar.area;
            const As_prime_prov = compressionRebar.area;
            
            const d_x = inputs.b - c_nom - inputs.linkDia - 16 / 2; // Assuming a 16mm bar for minor axis
            const M_abs = Math.abs(inputs.M);
            
            const d_tension_centroid_from_top = isHogging ? d_top_centroid : (inputs.h - d_bottom_centroid_from_bottom);
            const M_eff = M_abs - inputs.N * (inputs.h/2 - d_tension_centroid_from_top);
            
            let K = M_eff > 0 ? M_eff * 1e6 / (inputs.b * d_y**2 * inputs.fcu) : 0;
            const K_prime = (inputs.fcu <= 45) ? 0.156 : ((inputs.fcu <= 70) ? 0.120 : 0.094);

            let flexuralCalcs = {};
             if (K <= K_prime && M_eff > 0) {
                const z = Math.min(d_y * (0.5 + Math.sqrt(0.25 - K / 0.9)), 0.95 * d_y);
                const As_req = M_eff * 1e6 / (0.87 * inputs.fy * z);
                const x = (d_y - z) / 0.45;
                flexuralCalcs = { isDoubly: false, As_req, As_prime_req: 0, K, K_prime, z, x };
            } else if (M_eff > 0) {
                const z = d_y * (0.5 + Math.sqrt(0.25 - K_prime / 0.9));
                const As_prime_req = (M_eff * 1e6 - K_prime * inputs.fcu * inputs.b * d_y**2) / (0.87 * inputs.fy * (d_y - d_prime));
                const As_req = (K_prime * inputs.fcu * inputs.b * d_y**2) / (0.87 * inputs.fy * z) + As_prime_req;
                const x = (d_y - z) / 0.45;
                flexuralCalcs = { isDoubly: true, As_req, As_prime_req, K, K_prime, z, x };
            } else { // No effective moment or moment reversal
                flexuralCalcs = { isDoubly: false, As_req: 0, As_prime_req: 0, K:0, K_prime, z:0, x:0 };
            }
            
            const v_max_limit = Math.min(0.8 * Math.sqrt(inputs.fcu), 7.0);
            const vc_multiplier = (inputs.fcu > 25) ? Math.pow(inputs.fcu / 25, 1/3) : 1.0;
            const rho_l = As_prov > 0 ? Math.min(As_prov / (inputs.b * d_y), 0.03) : 0; // rho_l should not be taken > 3%
            
            const vy = inputs.Vy * 1e3 / (inputs.b * d_y);
            let vcy_base = (rho_l > 0) ? (0.79 * Math.pow(rho_l * 100, 1/3) * Math.pow(400/d_y, 1/4) / 1.25) * vc_multiplier : 0;
            const vcy = vcy_base;
            const vry = (inputs.fcu <= 40) ? 0.4 : 0.4 * Math.pow(inputs.fcu / 40, 2/3);
            
            let Asv_y_s_req = (vy < 0.5 * vcy) ? vry * inputs.b / (0.87 * inputs.fy) : (vy - vcy) * inputs.b / (0.87 * inputs.fy);
            if (vy < (vcy + vry) && vy > 0.5 * vcy) {
                 Asv_y_s_req = vry * inputs.b / (0.87 * inputs.fy);
            }
            const shearCalcsY = { v: vy, vc: vcy, vr: vry, Asv_s_req: Math.max(0, Asv_y_s_req) };
            
            const vx = inputs.Vx * 1e3 / (inputs.h * d_x);
            const vcx = vcy; // simplified assumption for minor axis
            let Asv_x_s_req = (vx < 0.5 * vcx) ? 0 : (vx - vcx) * inputs.h / (0.87 * inputs.fy);
            const shearCalcsX = { v: vx, vc: vcx, Asv_s_req: Math.max(0, Asv_x_s_req) };
            
            const h_max = Math.max(inputs.b, inputs.h), h_min = Math.min(inputs.b, inputs.h);
            const vt = (inputs.T > 0) ? (inputs.T * 1e6 * 2) / (h_min**2 * (h_max - h_min/3)) : 0;
            const vt_min = Math.min(0.067 * Math.sqrt(inputs.fcu), 0.6);
            const vtu = Math.min(0.8 * Math.sqrt(inputs.fcu), 7.0);
            let Asv_T_s_req = 0, Asl_req = 0;
            if (vt > vt_min) {
                const x1 = inputs.b - 2*c_nom - inputs.linkDia;
                const y1 = inputs.h - 2*c_nom - inputs.linkDia;
                Asv_T_s_req = (inputs.T * 1e6) / (0.8 * x1 * y1 * (0.87 * inputs.fy));
                Asl_req = (inputs.T * 1e6 * (x1 + y1)) / (0.8 * x1 * y1 * (0.87 * inputs.fy));
            }
            const torsionalCalcs = { vt, vt_min, vtu, Asv_T_s_req, Asl_req };
            const combined_Asv_s_req = shearCalcsY.Asv_s_req + shearCalcsX.Asv_s_req + torsionalCalcs.Asv_T_s_req;
            const Asv_s_prov = (inputs.numLinkLegs * barData[inputs.linkDia]) / inputs.linkSpacing;

            // --- SLS Checks ---
            // Deflection Check
            let basic_ratio;
            switch(inputs.supportCondition) {
                case 'cantilever': basic_ratio = 7; break;
                case 'continuous': basic_ratio = 26; break;
                default: basic_ratio = 20;
            }
            const fs_deflection = (As_prov > 0) ? (2/3) * inputs.fy * (flexuralCalcs.As_req / As_prov) : 0;
            const mod_factor_tension = (M_abs > 0) ? Math.min(2.0, 0.55 + (477 - fs_deflection) / (120 * (0.9 + (M_abs * 1e6) / (inputs.b * d_y**2)))) : 2.0;
            const rho_prime = (compressionRebar.area > 0) ? (100 * compressionRebar.area) / (inputs.b * d_y) : 0;
            const mod_factor_compression = Math.min(1.5, 1 + rho_prime / (3 + rho_prime));
            const allowable_ratio = basic_ratio * mod_factor_tension * mod_factor_compression;
            const actual_ratio = inputs.span * 1000 / d_y;
            const deflection_check = actual_ratio <= allowable_ratio;
            
            // Crack Width Check
            let w_k_flexural = 0;
            let fs_crack = 0;
            let x_sls = 0;
            let eps_m = 0;
            let acr_flexural = 0;

            const M_sls = Math.abs(inputs.M_sls);
            const isHogging_sls = inputs.M_sls >= 0;
            const tensionRebar_sls = isHogging_sls ? topBars : bottomBars;
            const compressionRebar_sls = isHogging_sls ? bottomBars : topBars;
            const As_prov_sls = tensionRebar_sls.area;
            const As_prime_prov_sls = compressionRebar_sls.area;
            const d_y_sls = isHogging_sls ? (inputs.h - d_top_centroid) : (inputs.h - d_bottom_centroid_from_bottom);
            const d_prime_sls = isHogging_sls ? d_bottom_centroid_from_bottom : d_top_centroid;
            
            const M_sls_eff = M_sls * 1e6 + inputs.N_sls * 1e3 * (inputs.h/2 - d_y_sls);

            if (M_sls_eff > 0 && As_prov_sls > 0) {
                const alpha_e = 15; // Modular ratio, common assumption
                const A = 0.5 * inputs.b;
                const B = alpha_e * As_prov_sls + (alpha_e - 1) * As_prime_prov_sls;
                const C = -(alpha_e * As_prov_sls * d_y_sls + (alpha_e - 1) * As_prime_prov_sls * d_prime_sls);
                
                x_sls = (-B + Math.sqrt(B**2 - 4 * A * C)) / (2 * A);
                
                const z_sls = d_y_sls - x_sls / 3;
                fs_crack = (M_sls_eff) / (As_prov_sls * z_sls);

                const tensionBarDiaValue = tensionRebar_sls.layers[0]?.dia || 0;
                const c_min = c_nom + inputs.linkDia;
                acr_flexural = tensionRebar_sls.num > 0 ? Math.sqrt((c_min + tensionBarDiaValue/2)**2 + (inputs.b / (2 * tensionRebar_sls.num))**2) - tensionBarDiaValue/2 : 0;
                
                const Es = 200000; // Young's Modulus for steel
                const eps1 = (fs_crack / Es) * ( (inputs.h - x_sls) / (d_y_sls - x_sls) );
                eps_m = eps1 - (inputs.b * (inputs.h - x_sls)**2) / (3 * Es * As_prov_sls * (d_y_sls - x_sls));

                w_k_flexural = (3 * acr_flexural * eps_m) / (1 + 2 * (acr_flexural - c_min) / (inputs.h - x_sls));
            }
            
            const alpha_t = 10e-6, eps_r = 0.8 * alpha_t * inputs.T1 * inputs.R;
            const tensionBarDiaValueForThermal = tensionRebar.layers[0]?.dia || 0;
            const acr_thermal = c_nom + inputs.linkDia + tensionBarDiaValueForThermal/2;
            const w_k_thermal = 3 * acr_thermal * eps_r;

            const total_crack_width = w_k_flexural + w_k_thermal;

            const crack_width_html = `
                <h4>Flexural Crack Calculation <span class="citation">Cl. 7.2.3</span></h4>
                <table>
                    <tr><td>Service Steel Stress, f<sub>s</sub></td><td class="formula">M<sub>sls,eff</sub> / (A<sub>s,prov</sub>&middot;z<sub>sls</sub>)</td><td>${fs_crack.toFixed(1)} N/mm²</td></tr>
                    <tr><td>Distance to corner of bar, a<sub>cr</sub></td><td>Calculated from geometry</td><td>${acr_flexural.toFixed(1)} mm</td></tr>
                    <tr><td>Average Strain, &epsilon;<sub>m</sub></td><td class="formula">&epsilon;<sub>1</sub> - f(b<sub>t</sub>,h,x,E<sub>s</sub>,A<sub>s</sub>,d)</td><td>${eps_m.toExponential(2)}</td></tr>
                    <tr><td>Calculated Flexural Crack Width, w<sub>k,flex</sub></td><td class="formula">3a<sub>cr</sub>&epsilon;<sub>m</sub> / (1+...)</td><td>${w_k_flexural.toFixed(3)} mm</td></tr>
                </table>
                <h4>Early Thermal Crack Calculation <span class="citation">Cl. 7.2.4</span></h4>
                <table>
                     <tr><td>Restrained Strain, &epsilon;<sub>r</sub></td><td class="formula">0.8 &alpha; T<sub>1</sub> R</td><td>${eps_r.toExponential(2)}</td></tr>
                    <tr><td>Distance to surface of bar, a<sub>cr</sub></td><td>c<sub>nom</sub> + &oslash;<sub>link</sub> + &oslash;<sub>bar</sub>/2</td><td>${acr_thermal.toFixed(1)} mm</td></tr>
                     <tr><td>Calculated Thermal Crack Width, w<sub>k,therm</sub></td><td class="formula">3 a<sub>cr</sub> &epsilon;<sub>r</sub></td><td>${w_k_thermal.toFixed(3)} mm</td></tr>
                </table>
                <h4>Total Crack Width Check</h4>
                <table>
                     <tr style="font-weight: bold;"><td>Total Estimated Crack Width, w<sub>k,total</sub></td><td class="formula">w<sub>k,flex</sub> + w<sub>k,therm</sub></td><td>${total_crack_width.toFixed(3)} mm</td></tr>
                     <tr><td>Allowable Crack Width</td><td>Per CoP 2013</td><td>0.3 mm <span class="citation">Table 7.1</span></td></tr>
                     <tr><td>Check</td><td>w<sub>k,total</sub> &le; 0.3</td><td class="${total_crack_width <= 0.3 ? 'check-ok' : 'check-fail'}">${total_crack_width <= 0.3 ? 'OK' : 'FAIL'}</td></tr>
                </table>
            `;

            const flex_ur = As_prov > 0 ? flexuralCalcs.As_req / As_prov : (flexuralCalcs.As_req > 0 ? 999 : 0);
            const shear_ur = v_max_limit > 0 ? shearCalcsY.v / v_max_limit : (shearCalcsY.v > 0 ? 999 : 0);
            const deflection_ur = allowable_ratio > 0 ? actual_ratio / allowable_ratio : (actual_ratio > 0 ? 999 : 0);
            const overall_ur = Math.max(flex_ur, shear_ur, deflection_ur);

            return { 
                inputs, 
                calcs: { M_eff, c_nom, d_y, d_prime, flexuralCalcs, topBars, bottomBars, As_prov, As_prime_prov, shearCalcsY, shearCalcsX, v_max_limit, torsionalCalcs, combined_Asv_s_req, Asv_s_prov, deflection_check, allowable_ratio, actual_ratio, crack_width_html, finalLinkDia: inputs.linkDia, sv_prov: inputs.linkSpacing, basic_ratio, tensionRebar, compressionRebar },
                utilization: {
                    flex: flex_ur,
                    shear: shear_ur,
                    deflection: deflection_ur,
                    overall: overall_ur
                }
            };
        }

        function runBatchAnalysis() {
            // 1. Get Base Inputs
            const supportConditionEl = document.getElementById('supportCondition');
            const baseInputs = {
                fcu: parseFloat(document.getElementById('fcu')?.value || 35),
                fy: parseFloat(document.getElementById('fy')?.value || 500), 
                b: parseFloat(document.getElementById('b')?.value || 0),
                h: parseFloat(document.getElementById('h')?.value || 0), 
                span: parseFloat(document.getElementById('span')?.value || 0),
                c_nom: parseFloat(document.getElementById('c_nom')?.value || 35),
                linkDia: parseFloat(document.getElementById('linkDia')?.value || 10),
                numLinkLegs: parseInt(document.getElementById('numLinkLegs')?.value || 2),
                linkSpacing: parseFloat(document.getElementById('linkSpacing')?.value || 200),
                aggSize: parseFloat(document.getElementById('aggSize')?.value || 20),
                R: parseFloat(document.getElementById('restraintFactor')?.value || 0), 
                T1: parseFloat(document.getElementById('tempDrop')?.value || 0),
                supportCondition: supportConditionEl ? supportConditionEl.value : 'simply-supported',
                includeOverview: document.getElementById('includeOverview').checked
            };

            // 2. Get Rebar Inputs
            const topLayers = [], bottomLayers = [];
            document.querySelectorAll('#top-layers-container tr').forEach((row) => {
                const num = parseInt(row.querySelector('.num-bars').value) || 0;
                const dia = parseFloat(row.querySelector('.bar-dia').value) || 0;
                const spacing = row.querySelector('.clear-spacing') ? (parseFloat(row.querySelector('.clear-spacing').value) || 25) : 25;
                if(num > 0 && dia > 0) topLayers.push({ num, dia, area: num * barData[dia], spacing });
            });
            document.querySelectorAll('#bottom-layers-container tr').forEach((row) => {
                const num = parseInt(row.querySelector('.num-bars').value) || 0;
                const dia = parseFloat(row.querySelector('.bar-dia').value) || 0;
                const spacing = row.querySelector('.clear-spacing') ? (parseFloat(row.querySelector('.clear-spacing').value) || 25) : 25;
                if(num > 0 && dia > 0) bottomLayers.push({ num, dia, area: num * barData[dia], spacing });
            });
            const rebarInputs = { topLayers, bottomLayers };

            // 3. Parse Load Cases from table
            const rows = document.querySelectorAll('#load-case-tbody tr');
            const loadCases = [];
            rows.forEach(row => {
                const inputs = row.querySelectorAll('input');
                if (inputs.length === 8) {
                    loadCases.push({
                        caseName: inputs[0].value || `Case-${loadCases.length + 1}`,
                        N: parseFloat(inputs[1].value) || 0,
                        Vy: parseFloat(inputs[2].value) || 0,
                        Vx: parseFloat(inputs[3].value) || 0,
                        M: parseFloat(inputs[4].value) || 0,
                        T: parseFloat(inputs[5].value) || 0,
                        M_sls: parseFloat(inputs[6].value) || 0,
                        N_sls: parseFloat(inputs[7].value) || 0
                    });
                }
            });


            if (loadCases.length === 0) {
                document.getElementById('output-section').innerHTML = '<div class="page-container"><p>Please add at least one load case to the table.</p></div>';
                return;
            }

            // 4. Run calculations for all cases
            allResults = loadCases.map(lc => calculate(lc, baseInputs, rebarInputs));

            // 5. Find the critical case
            let criticalCase = allResults[0];
            let criticalIndex = 0;
            for (let i = 1; i < allResults.length; i++) {
                if (allResults[i].utilization.overall > criticalCase.utilization.overall) {
                    criticalCase = allResults[i];
                    criticalIndex = i;
                }
            }
            
            lastCriticalCase = criticalCase; // Store for AI functions

            // 6. Generate Reports
            const summaryReportHTML = generateSummaryReport(allResults, criticalIndex);
            const detailedReportHTML = generateDetailedReport(criticalCase.inputs, criticalCase.calcs);

            document.getElementById('output-section').innerHTML = summaryReportHTML + detailedReportHTML;
            
            // 7. Check for failure and trigger AI
            checkFailureAndTriggerAI(criticalCase);

            saveDataToLocalStorage();
        }
        
        // --- Report Generation & Rendering ---
        function generateReportHeader(title, subTitle, designer, checkedBy, date, revision, logoSrc) {
            return `
                <div class="report-header">
                    <div class="logo-container">${logoSrc ? `<img src="${logoSrc}" alt="Company Logo">` : 'Logo'}</div>
                    <div class="right-content">
                        <div class="title-container"><h2>${title}</h2><h3>${subTitle}</h3></div>
                        <div class="info-container">
                             <div class="info-cell"><p><span>Project No:</span><br>BEAM-001</p></div>
                             <div class="info-cell"><p><span>Designed By:</span> ${designer}<br><span>Checked By:</span> ${checkedBy}</p></div>
                             <div class="info-cell"><p><span>Date:</span> ${date}<br><span>Revision:</span> ${revision}</p></div>
                        </div>
                    </div>
                </div>
            `;
        }

        function generateSummaryReport(results, criticalIndex) {
            const designer = document.getElementById('designerName').value || 'N/A', checkedBy = document.getElementById('checkedBy').value || 'N/A';
            const title = document.getElementById('projectTitle').value || 'N/A', subTitle = 'Load Case Summary';
            const date = document.getElementById('reportDate').value || new Date().toISOString().slice(0, 10), revision = document.getElementById('reportRevision').value || 'N/A';
            const logoInput = document.getElementById('companyLogo').files[0], logoSrc = logoInput ? URL.createObjectURL(logoInput) : '';

            let tableRows = '';
            results.forEach((res, index) => {
                const flex_ur = res.utilization.flex;
                const shear_ur = res.utilization.shear;
                const defl_ur = res.utilization.deflection;
                
                const getBarColor = (ur) => {
                    if (ur > 1.0) return 'var(--danger-color)';
                    if (ur > 0.8) return 'var(--warning-color)';
                    return 'var(--success-color)';
                };

                tableRows += `
                    <tr data-case-index="${index}" class="${index === criticalIndex ? 'critical' : ''}">
                        <td>${res.inputs.caseName}</td>
                        <td>${res.inputs.N.toFixed(2)}</td>
                        <td>${res.inputs.Vy.toFixed(2)}</td>
                        <td>${res.inputs.Vx.toFixed(2)}</td>
                        <td>${res.inputs.M.toFixed(2)}</td>
                        <td>${res.inputs.T.toFixed(2)}</td>
                        <td class="${flex_ur > 1.0 ? 'check-fail' : ''}">${flex_ur.toFixed(2)} <div class="utilization-bar"><div class="utilization-bar-inner" style="width: ${Math.min(flex_ur, 1) * 100}%; background-color: ${getBarColor(flex_ur)};"></div></div></td>
                        <td class="${shear_ur > 1.0 ? 'check-fail' : ''}">${shear_ur.toFixed(2)} <div class="utilization-bar"><div class="utilization-bar-inner" style="width: ${Math.min(shear_ur, 1) * 100}%; background-color: ${getBarColor(shear_ur)};"></div></div></td>
                        <td class="${defl_ur > 1.0 ? 'check-fail' : ''}">${defl_ur.toFixed(2)} <div class="utilization-bar"><div class="utilization-bar-inner" style="width: ${Math.min(defl_ur, 1) * 100}%; background-color: ${getBarColor(defl_ur)};"></div></div></td>
                    </tr>
                `;
            });

            return `
                <div class="page-container" id="load-case-summary">
                    ${generateReportHeader(title, subTitle, designer, checkedBy, date, revision, logoSrc)}
                    <h2>Load Case Summary <span class="citation">(Click a row to view detailed report)</span></h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Case</th>
                                <th>N (kN)</th>
                                <th>V<sub>y</sub> (kN)</th>
                                <th>V<sub>x</sub> (kN)</th>
                                <th>M (kNm)</th>
                                <th>T (kNm)</th>
                                <th>Flexure U.R.</th>
                                <th>Shear U.R.</th>
                                <th>Deflection U.R.</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        function generateDetailedReport(inputs, calcs) {
            const { M_eff, c_nom, d_y, d_prime, flexuralCalcs, topBars, bottomBars, As_prov, As_prime_prov, shearCalcsY, shearCalcsX, v_max_limit, torsionalCalcs, combined_Asv_s_req, Asv_s_prov, deflection_check, allowable_ratio, actual_ratio, crack_width_html, finalLinkDia, sv_prov, basic_ratio, tensionRebar, compressionRebar } = calcs;
            const v_res = Math.sqrt(shearCalcsY.v**2 + shearCalcsX.v**2);

            const designer = document.getElementById('designerName').value || 'N/A', checkedBy = document.getElementById('checkedBy').value || 'N/A';
            const title = document.getElementById('projectTitle').value || 'N/A', subTitle = document.getElementById('projectSubTitle').value || 'Design Calculation Report';
            const date = document.getElementById('reportDate').value || new Date().toISOString().slice(0, 10), revision = document.getElementById('reportRevision').value || 'N/A';
            const logoInput = document.getElementById('companyLogo').files[0], logoSrc = logoInput ? URL.createObjectURL(logoInput) : '';

            const shear_design_status_html = (sv_prov > 0) ? `<td class="final-rebar">T${finalLinkDia} @ ${sv_prov} mm c/c (${inputs.numLinkLegs} legs)</td><td>${Asv_s_prov.toFixed(3)}</td><td class="${Asv_s_prov >= combined_Asv_s_req ? 'check-ok' : 'check-fail'}">${Asv_s_prov >= combined_Asv_s_req ? 'OK' : 'FAIL'}</td>` : `<td class="check-fail" colspan="3">FAIL. Increase section/link size.</td>`;
            
            let flex_util_ratio = (As_prov > 0) ? flexuralCalcs.As_req / As_prov : (flexuralCalcs.As_req > 0 ? 999 : 0);
            let topBarSummary = topBars.layers.map(l => `${l.num}T${l.dia}`).join(' + ') || 'None';
            let bottomBarSummary = bottomBars.layers.map(l => `${l.num}T${l.dia}`).join(' + ') || 'None';

            let sectionCounter = 1;
            
            let overviewHTML = '';
            if (inputs.includeOverview) {
                overviewHTML = `
                <div id="overview-section">
                    <h2>${sectionCounter++}. Overview</h2>
                    <p id="overview-content-p">${document.getElementById('ai-overview-text').value || 'This report details the structural design verification for a reinforced concrete beam section according to the Hong Kong Code of Practice for the Structural Use of Concrete 2013. The analysis covers Ultimate Limit State (ULS) checks for flexure, shear, and torsion, as well as Serviceability Limit State (SLS) checks for deflection and cracking under various load combinations.'}</p>
                </div>`;
            }
            
            const criticalCaseTableHTML = `
                <h4>Design Load Case: ${inputs.caseName}</h4>
                <table>
                    <thead>
                        <tr>
                            <th>N (kN)</th>
                            <th>V<sub>y</sub> (kN)</th>
                            <th>V<sub>x</sub> (kN)</th>
                            <th>M (kNm)</th>
                            <th>T (kNm)</th>
                            <th>M<sub>sls</sub> (kNm)</th>
                            <th>N<sub>sls</sub> (kN)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>${inputs.N.toFixed(2)}</td>
                            <td>${inputs.Vy.toFixed(2)}</td>
                            <td>${inputs.Vx.toFixed(2)}</td>
                            <td>${inputs.M.toFixed(2)}</td>
                            <td>${inputs.T.toFixed(2)}</td>
                            <td>${inputs.M_sls.toFixed(2)}</td>
                            <td>${inputs.N_sls.toFixed(2)}</td>
                        </tr>
                    </tbody>
                </table>
            `;

            let html = `
            <div class="page-container" id="detailed-report-container">
                ${generateReportHeader(title, `${subTitle} (Design Case: ${inputs.caseName})`, designer, checkedBy, date, revision, logoSrc)}
                ${overviewHTML}
                
                <h2>${sectionCounter++}. Design Check Summary</h2>
                <div class="design-summary-container">
                    <div class="summary-card-container">
                        <div class="summary-card">
                            <h4>Section & Reinforcement</h4>
                            <p><strong>Section:</strong> ${inputs.b}mm &times; ${inputs.h}mm</p>
                            <p><strong>Top Bars:</strong> <span class="final-rebar">${topBarSummary}</span></p>
                            <p><strong>Bottom Bars:</strong> <span class="final-rebar">${bottomBarSummary}</span></p>
                            <p><strong>Shear Links:</strong> <span class="final-rebar">T${finalLinkDia} @ ${sv_prov > 0 ? sv_prov : 'N/A'} mm c/c (${inputs.numLinkLegs} legs)</span></p>
                        </div>
                        <div class="summary-card">
                             <h4>Key Utilization Ratios</h4>
                             <p><strong>Flexure (A<sub>s,req</sub>/A<sub>s,prov</sub>):</strong> ${flex_util_ratio.toFixed(2)} <span class="${flex_util_ratio <= 1 ? 'check-ok' : 'check-fail'}">${flex_util_ratio <= 1 ? 'OK' : 'FAIL'}</span></p>
                             <p><strong>Shear (v<sub>y</sub>/v<sub>max</sub>):</strong> ${(shearCalcsY.v / v_max_limit).toFixed(2)} <span class="${shearCalcsY.v <= v_max_limit ? 'check-ok' : 'check-fail'}">${shearCalcsY.v <= v_max_limit ? 'OK' : 'FAIL'}</span></p>
                             <p><strong>Deflection (Actual/Allow):</strong> ${(actual_ratio / allowable_ratio).toFixed(2)} <span class="${deflection_check ? 'check-ok' : 'check-fail'}">${deflection_check ? 'OK' : 'FAIL'}</span></p>
                        </div>
                    </div>
                    <div class="beam-sketch">
                         ${generateRebarSVG(bottomBars, topBars, inputs, c_nom, 40, finalLinkDia)}
                         <h3>Typical Cross-Section</h3>
                    </div>
                </div>
               
                <h2>${sectionCounter++}. Design Parameters & Material Properties</h2>
                <table><tr><th>Parameter</th><th>Formula</th><th>Value</th><th>Reference</th></tr>
                <tr><td>Effective Depth (Tension), d</td><td class="formula">Calculated Centroid</td><td>${d_y.toFixed(1)} mm</td><td></td></tr>
                <tr><td>Effective Depth (Comp.), d'</td><td class="formula">Calculated Centroid</td><td>${d_prime.toFixed(1)} mm</td><td></td></tr>
                <tr><td>Concrete Grade, f<sub>cu</sub></td><td>-</td><td>${inputs.fcu} N/mm²</td><td><span class="citation">Table 3.1</span></td></tr>
                <tr><td>Rebar Grade, f<sub>y</sub></td><td>-</td><td>${inputs.fy} N/mm²</td><td><span class="citation">Table 3.3</span></td></tr>
                <tr><td>Nominal Cover, c<sub>nom</sub></td><td>User Input</td><td>${c_nom} mm</td><td><span class="citation">Cl 4.2.4</span></td></tr>
                </table>
                
                <h2>${sectionCounter++}. Loading Input</h2>
                ${criticalCaseTableHTML}

                <h2>${sectionCounter++}. Flexural Design (ULS) <span class="citation">Cl. 6.1.2</span></h2>
                <table><tr><td>Design Moment, M<sub>eff</sub></td><td>Adjusted for axial load</td><td>${M_eff > 0 ? (M_eff / 1e6).toFixed(2) : "N/A"} kNm</td></tr><tr><td>K</td><td class="formula">M<sub>eff</sub> / (b&middot;d²&middot;f<sub>cu</sub>)</td><td>${flexuralCalcs.K.toFixed(3)}</td></tr><tr><td>K' Limit</td><td>For f<sub>cu</sub>=${inputs.fcu} N/mm²</td><td>${flexuralCalcs.K_prime.toFixed(3)} <span class="citation">Cl 6.1.2.4(b)</span></td></tr>
                <tr><td>Check K &le; K'</td><td></td><td class="${!flexuralCalcs.isDoubly ? 'check-ok' : 'check-fail'}">${!flexuralCalcs.isDoubly ? 'OK - Singly Reinforced' : 'Doubly Reinforced Required'}</td></tr>
                </table>
                ${!flexuralCalcs.isDoubly ? `<table><tr><td>Lever Arm, z</td><td class="formula">d&middot;[0.5 + &radic;(0.25-K/0.9)]</td><td>${flexuralCalcs.z.toFixed(1)} mm</td></tr>
                <tr><td>Required Tension Steel, A<sub>s,req</sub></td><td class="formula">M<sub>eff</sub> / (0.87f<sub>y</sub>z)</td><td>${flexuralCalcs.As_req.toFixed(1)} mm²</td></tr>
                <tr><td>Proposed Tension Steel</td><td>-</td><td class="final-rebar">${tensionRebar.layers.map(l => l.num + 'T' + l.dia).join(' + ')} (${As_prov.toFixed(1)} mm²)</td></tr>
                <tr><td>Check</td><td>A<sub>s,prov</sub> &ge; A<sub>s,req</sub></td><td class="${As_prov >= flexuralCalcs.As_req ? 'check-ok' : 'check-fail'}">${As_prov >= flexuralCalcs.As_req ? 'OK' : 'FAIL'}</td></tr>
                </table>` : `<table><tr><td>Lever Arm, z</td><td class="formula">d&middot;[0.5 + &radic;(0.25-K'/0.9)]</td><td>${flexuralCalcs.z.toFixed(1)} mm</td></tr>
                <tr><td>Req. Compression Steel, A'<sub>s,req</sub></td><td class="formula">(M<sub>eff</sub>-M<sub>limit</sub>)/(0.87f<sub>y</sub>(d-d'))</td><td>${flexuralCalcs.As_prime_req.toFixed(1)} mm²</td></tr>
                <tr><td>Proposed Comp. Steel</td><td>-</td><td class="final-rebar">${compressionRebar.layers.map(l => l.num + 'T' + l.dia).join(' + ')} (${As_prime_prov.toFixed(1)} mm²)</td></tr>
                <tr><td>Required Tension Steel, A<sub>s,req</sub></td><td class="formula">A<sub>s,bal</sub> + A'<sub>s,req</sub></td><td>${flexuralCalcs.As_req.toFixed(1)} mm²</td></tr>
                <tr><td>Proposed Tension Steel</td><td>-</td><td class="final-rebar">${tensionRebar.layers.map(l => l.num + 'T' + l.dia).join(' + ')} (${As_prov.toFixed(1)} mm²)</td></tr>
                <tr><td>Check</td><td>A<sub>s,prov</sub> &ge; A<sub>s,req</sub></td><td class="${As_prov >= flexuralCalcs.As_req ? 'check-ok' : 'check-fail'}">${As_prov >= flexuralCalcs.As_req ? 'OK' : 'FAIL'}</td></tr>
                </table>`}
                
                <h2>${sectionCounter++}. Shear Design (ULS) <span class="citation">Cl. 6.1.2.5</span></h2>
                <h3>Major Axis (Y-Y) Shear</h3>
                <table><tr><td>Design Shear Stress, v<sub>y</sub></td><td class="formula">V<sub>y</sub> / (bd)</td><td>${shearCalcsY.v.toFixed(2)} N/mm²</td></tr>
                <tr><td>Concrete Shear Capacity, v<sub>c</sub></td><td>From Table 6.3</td><td>${shearCalcsY.vc.toFixed(2)} N/mm² <span class="citation">Table 6.3</span></td></tr>
                <tr><td>Req. Shear Links, (A<sub>sv</sub>/s<sub>v</sub>)<sub>y</sub></td><td class="formula">(v<sub>y</sub> - v<sub>c</sub>)b / (0.87f<sub>yv</sub>)</td><td>${shearCalcsY.Asv_s_req.toFixed(3)}</td></tr>
                </table>
                <h3>Minor Axis (X-X) Shear (Simplified)</h3>
                <table><tr><td>Design Shear Stress, v<sub>x</sub></td><td class="formula">V<sub>x</sub> / (hd<sub>x</sub>)</td><td>${shearCalcsX.v.toFixed(2)} N/mm²</td></tr>
                 <tr><td>Concrete Shear Capacity, v<sub>c</sub></td><td>Assumed same as v<sub>cy</sub></td><td>${shearCalcsX.vc.toFixed(2)} N/mm²</td></tr>
                 <tr><td>Req. Shear Links, (A<sub>sv</sub>/s<sub>v</sub>)<sub>x</sub></td><td class="formula">(v<sub>x</sub> - v<sub>c</sub>)h / (0.87f<sub>yv</sub>)</td><td>${shearCalcsX.Asv_s_req.toFixed(3)}</td></tr>
                </table>
                
                <h2>${sectionCounter++}. Torsional Design (ULS) <span class="citation">Cl. 6.3</span></h2>
                <table>
                <tr><td>Torsional Shear Stress, v<sub>t</sub></td><td>Calculated</td><td>${torsionalCalcs.vt.toFixed(2)} N/mm² <span class="citation">Cl 6.3.3</span></td></tr>
                <tr><td>Resultant Shear Stress, v<sub>res</sub></td><td class="formula">&radic;(v<sub>y</sub>² + v<sub>x</sub>²)</td><td>${v_res.toFixed(2)} N/mm²</td></tr>
                <tr><td>Check v<sub>res</sub>+v<sub>t</sub> &le; v<sub>tu</sub></td><td>${(v_res + torsionalCalcs.vt).toFixed(2)} &le; ${torsionalCalcs.vtu.toFixed(2)}</td><td class="${(v_res + torsionalCalcs.vt) <= torsionalCalcs.vtu ? 'check-ok' : 'check-fail'}">${(v_res + torsionalCalcs.vt) <= torsionalCalcs.vtu ? 'OK' : 'FAIL'}</td></tr>
                ${torsionalCalcs.vt > torsionalCalcs.vt_min ? `<tr><td>Req. A<sub>sv</sub>/s<sub>v</sub> (Torsion)</td><td></td><td>${torsionalCalcs.Asv_T_s_req.toFixed(3)}</td></tr>` : `<tr><td colspan="3">v<sub>t</sub> &le; v<sub>t,min</sub>. No torsional reinforcement required.</td></tr>`}</table>
                
                <h4>Combined Shear & Torsion Links</h4><table>
                <tr><td>Total Required A<sub>sv</sub>/s<sub>v</sub></td><td class="formula">(A<sub>sv</sub>/s<sub>v</sub>)<sub>y</sub> + (A<sub>sv</sub>/s<sub>v</sub>)<sub>x</sub> + (A<sub>sv</sub>/s<sub>v</sub>)<sub>T</sub></td><td>${combined_Asv_s_req.toFixed(3)}</td></tr>
                <tr><td>Proposed Links</td><td>A<sub>sv</sub>/s<sub>v</sub></td>${shear_design_status_html}</tr></table>
                
                <h2>${sectionCounter++}. Deflection Check (SLS) <span class="citation">Cl. 7.3</span></h2>
                <table><tr><td>Basic Span/Depth Ratio</td><td>Based on Support Condition</td><td>${basic_ratio} <span class="citation">Table 7.3</span></td></tr>
                <tr><td>Allowable Span/Depth Ratio</td><td>Adjusted for steel areas</td><td>${allowable_ratio.toFixed(1)} <span class="citation">Table 7.4/7.5</span></td></tr><tr><td>Actual Span/Depth Ratio</td><td class="formula">L / d</td><td>${actual_ratio.toFixed(1)}</td></tr><tr><td>Deflection Check</td><td>Actual &le; Allowable</td><td class="${deflection_check ? 'check-ok' : 'check-fail'}">${deflection_check ? 'OK' : 'FAIL'}</td></tr></table>
                
                <h2>${sectionCounter++}. Crack Width Check (SLS) <span class="citation">Cl. 7.2</span></h2>
                ${crack_width_html}
            </div>`;
            return html;
        }
        
        // --- AI Integration ---
        async function callAI(prompt) {
            const provider = document.getElementById('aiProvider').value;
            const apiKey = document.getElementById('apiKey').value;
            let apiUrl = document.getElementById('apiUrl').value;
            let payload;
            let headers = { 'Content-Type': 'application/json' };

            if (!apiKey) {
                return "Error: API Key is missing. Please enter it in the 'Advanced AI Settings' section.";
            }

            if (provider === 'gemini') {
                apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }]
                };
            } else { // Custom provider
                if (!apiUrl) {
                    return "Error: Custom API URL is missing. Please enter it in the 'Advanced AI Settings' section.";
                }
                // NOTE: This is a placeholder structure for an OpenAI-like API.
                // Users must adapt this for their specific custom API provider.
                payload = {
                    model: "custom-model-name", // Example: "gpt-4"
                    messages: [{ role: "user", content: prompt }] 
                };
                headers['Authorization'] = `Bearer ${apiKey}`;
            }

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                     const errorBody = await response.text();
                     console.error("API Error Response:", errorBody);
                    throw new Error(`API call failed with status: ${response.status}`);
                }
                const result = await response.json();
                
                // Handle response based on provider
                if (provider === 'gemini') {
                    if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                        return result.candidates[0].content.parts[0].text;
                    }
                } else { // Custom provider response handling
                    // NOTE: This part needs to be adapted for the specific custom API's response structure.
                    // This is an example for an OpenAI-like response.
                    if (result.choices && result.choices.length > 0) {
                        return result.choices[0].message.content;
                    }
                }
                return "AI could not generate a response. Check the console for the API response structure.";
            } catch (error) {
                console.error("Error calling AI API:", error);
                return `Error communicating with AI: ${error.message}`;
            }
        }

        async function getAIRecommendation() {
            const recommendationOutput = document.getElementById('recommendation-output');
            recommendationOutput.textContent = 'Asking the AI for suggestions...';

            const { inputs, calcs, utilization } = lastCriticalCase;
            let failureInfo = `The RC beam design for load case '${inputs.caseName}' has failed. `;
            if (utilization.flex > 1.0) {
                failureInfo += `Flexural check failed (UR=${utilization.flex.toFixed(2)}). Required tension steel area is ${calcs.flexuralCalcs.As_req.toFixed(0)} mm², but only ${calcs.As_prov.toFixed(0)} mm² was provided. `;
            }
            if (utilization.shear > 1.0) {
                failureInfo += `Shear check failed (UR=${utilization.shear.toFixed(2)}). Design shear stress v=${calcs.shearCalcsY.v.toFixed(2)} N/mm² exceeds the maximum capacity v_max=${calcs.v_max_limit.toFixed(2)} N/mm². `;
            }
            if (!calcs.deflection_check) {
                failureInfo += `Deflection check failed (UR=${(calcs.actual_ratio / calcs.allowable_ratio).toFixed(2)}). The actual span/depth ratio of ${calcs.actual_ratio.toFixed(1)} exceeds the allowable ratio of ${calcs.allowable_ratio.toFixed(1)}. `;
            }
            const prompt = `
                As an expert structural engineer, the following RC beam design has failed according to HK CoP 2013.
                Provide brief, straightforward, and numbered recommendations to resolve the failure.

                Beam Dimensions: ${inputs.b}mm x ${inputs.h}mm
                Concrete: fcu = ${inputs.fcu} MPa
                Steel: fy = ${inputs.fy} MPa
                
                Failure Details: ${failureInfo}

                Recommendations:
            `;
            const recommendation = await callAI(prompt);
            recommendationOutput.textContent = recommendation;
        }
        
        async function generateAIOverview() {
            const overviewTextarea = document.getElementById('ai-overview-text');
            overviewTextarea.value = 'Generating overview...';
            const prompt = `
                Generate a brief, professional project overview for a structural design report.
                Project Title: ${document.getElementById('projectTitle').value}
                Subtitle: ${document.getElementById('projectSubTitle').value}
                The report is for a reinforced concrete beam design check according to the Hong Kong Code of Practice for Concrete 2013.
                The check includes ULS for flexure, shear, torsion, and SLS for deflection and cracking.
            `;
            const overview = await callAI(prompt);
            overviewTextarea.value = overview;
            if (document.getElementById('overview-content-p')) {
                document.getElementById('overview-content-p').textContent = overview;
            }
        }
        
        async function rephraseAIOverview() {
            const overviewTextarea = document.getElementById('ai-overview-text');
            const originalText = overviewTextarea.value;
            if (!originalText.trim() || originalText === 'Generating overview...') return;
            overviewTextarea.value = 'Rephrasing...';
            const prompt = `Rephrase the following text to be more professional and suitable for a structural engineering report: "${originalText}"`;
            const rephrased = await callAI(prompt);
            overviewTextarea.value = rephrased;
             if (document.getElementById('overview-content-p')) {
                document.getElementById('overview-content-p').textContent = rephrased;
            }
        }

        function checkFailureAndTriggerAI(criticalCase) {
            const recommendationSection = document.getElementById('recommendation-section');
            const recommendationOutput = document.getElementById('recommendation-output');
            
            const isFailure = criticalCase.utilization.overall > 1.0;
            
            if (isFailure) {
                recommendationSection.style.display = 'block';
                let failureSummary = `Critical load case '${criticalCase.inputs.caseName}' failed with an overall utilization ratio of ${criticalCase.utilization.overall.toFixed(2)}.`;
                recommendationOutput.textContent = failureSummary;
            } else {
                recommendationSection.style.display = 'none';
            }
        }


        // --- Event Listeners & Initialization ---

        window.onload = function() {
            document.body.addEventListener('click', (event) => {
                const target = event.target;
                if (target.id === 'add-load-case-btn') { addLoadCaseRow(); runBatchAnalysis(); } 
                else if (target.id === 'paste-data-btn') { showPasteModal(); }
                else if (target.id === 'process-paste-btn') { processPastedData(); }
                else if (target.id === 'cancel-paste-btn') { hidePasteModal(); }
                else if (target.id === 'add-top-layer-btn') { addLayer('top'); runBatchAnalysis(); }
                else if (target.id === 'add-bottom-layer-btn') { addLayer('bottom'); runBatchAnalysis(); }
                else if (target.classList.contains('remove-layer-btn')) { target.closest('tr').remove(); runBatchAnalysis(); }
                else if (target.id === 'calc-btn') { runBatchAnalysis(); }
                else if (target.id === 'print-btn') { window.print(); }
                else if (target.id === 'reset-btn') { if (confirm("Are you sure you want to reset all inputs?")) { localStorage.removeItem('rcBeamCalculatorData'); window.location.reload(); } }
                else if (target.id === 'generate-overview-btn') { generateAIOverview(); }
                else if (target.id === 'rephrase-overview-btn') { rephraseAIOverview(); }
                else if (target.id === 'ai-recommend-btn') { getAIRecommendation(); }
                else if (target.closest('#load-case-summary tbody tr')) {
                    const row = target.closest('tr');
                    const caseIndex = parseInt(row.getAttribute('data-case-index'));
                    if (!isNaN(caseIndex) && allResults[caseIndex]) {
                        const newDetailedReport = generateDetailedReport(allResults[caseIndex].inputs, allResults[caseIndex].calcs);
                        const oldReport = document.getElementById('detailed-report-container');
                        if (oldReport) oldReport.outerHTML = newDetailedReport;
                        document.querySelectorAll('#load-case-summary tbody tr').forEach(r => r.classList.remove('critical'));
                        row.classList.add('critical');
                        lastCriticalCase = allResults[caseIndex];
                        checkFailureAndTriggerAI(lastCriticalCase);
                    }
                }
            });

            const inputsPanel = document.querySelector('.inputs-panel');
            if (inputsPanel) {
                inputsPanel.addEventListener('input', (event) => { if (event.target.matches('input, textarea')) { runBatchAnalysis(); } });
                inputsPanel.addEventListener('change', (event) => { 
                    if (event.target.matches('select, input[type=checkbox]')) { 
                        if (event.target.id === 'aiProvider') {
                            const apiUrlInput = document.getElementById('apiUrl');
                            if (event.target.value === 'gemini') {
                                apiUrlInput.value = ''; // Clear it, it will be constructed with the key later
                                apiUrlInput.placeholder = 'Gemini API URL (auto-populated)';
                            } else {
                                apiUrlInput.value = '';
                                apiUrlInput.placeholder = 'e.g., https://api.openai.com/v1/chat/completions';
                            }
                        }
                        runBatchAnalysis(); 
                    } 
                });
            }
             
             loadDataFromLocalStorage();
        };

        function saveDataToLocalStorage() {
            const data = {
                reportDetails: {},
                detailing: {},
                rebar: { top: [], bottom: [] },
                loadCases: [],
                aiSettings: {}
            };
            document.querySelectorAll('#designerName, #checkedBy, #projectTitle, #projectSubTitle, #reportDate, #reportRevision, #includeOverview, #ai-overview-text').forEach(el => {
                data.reportDetails[el.id] = el.type === 'checkbox' ? el.checked : el.value;
            });
            document.querySelectorAll('#fcu, #fy, #supportCondition, #span, #b, #h, #c_nom, #aggSize, #linkDia, #numLinkLegs, #linkSpacing, #restraintFactor, #tempDrop').forEach(el => {
                data.detailing[el.id] = el.value;
            });
            document.querySelectorAll('#top-layers-container tr').forEach(row => {
                data.rebar.top.push({
                    num: row.querySelector('.num-bars').value,
                    dia: row.querySelector('.bar-dia').value,
                    spacing: row.querySelector('.clear-spacing') ? row.querySelector('.clear-spacing').value : 'N/A'
                });
            });
            document.querySelectorAll('#bottom-layers-container tr').forEach(row => {
                data.rebar.bottom.push({
                    num: row.querySelector('.num-bars').value,
                    dia: row.querySelector('.bar-dia').value,
                    spacing: row.querySelector('.clear-spacing') ? row.querySelector('.clear-spacing').value : 'N/A'
                });
            });
            document.querySelectorAll('#load-case-tbody tr').forEach(row => {
                const inputs = row.querySelectorAll('input');
                data.loadCases.push(Array.from(inputs).map(i => i.value));
            });
            document.querySelectorAll('#aiProvider, #apiUrl, #apiKey').forEach(el => {
                data.aiSettings[el.id] = el.value;
            });
            localStorage.setItem('rcBeamCalculatorData', JSON.stringify(data));
        }

        function loadDataFromLocalStorage() {
            const savedData = localStorage.getItem('rcBeamCalculatorData');
            if (savedData) {
                const data = JSON.parse(savedData);
                for (const id in data.reportDetails) {
                    const el = document.getElementById(id);
                    if (el) {
                        if (el.type === 'checkbox') el.checked = data.reportDetails[id];
                        else el.value = data.reportDetails[id];
                    }
                }
                for (const id in data.detailing) {
                    const el = document.getElementById(id);
                    if (el) el.value = data.detailing[id];
                }
                if (data.aiSettings) {
                    for (const id in data.aiSettings) {
                        const el = document.getElementById(id);
                        if (el) el.value = data.aiSettings[id];
                    }
                }
                const topContainer = document.getElementById('top-layers-container');
                topContainer.innerHTML = '';
                data.rebar.top.forEach(layer => addLayer('top'));
                document.querySelectorAll('#top-layers-container tr').forEach((row, i) => {
                    row.querySelector('.num-bars').value = data.rebar.top[i].num;
                    row.querySelector('.bar-dia').value = data.rebar.top[i].dia;
                    if(row.querySelector('.clear-spacing')) row.querySelector('.clear-spacing').value = data.rebar.top[i].spacing;
                });
                const bottomContainer = document.getElementById('bottom-layers-container');
                bottomContainer.innerHTML = '';
                data.rebar.bottom.forEach(layer => addLayer('bottom'));
                document.querySelectorAll('#bottom-layers-container tr').forEach((row, i) => {
                    row.querySelector('.num-bars').value = data.rebar.bottom[i].num;
                    row.querySelector('.bar-dia').value = data.rebar.bottom[i].dia;
                    if(row.querySelector('.clear-spacing')) row.querySelector('.clear-spacing').value = data.rebar.bottom[i].spacing;
                });
                const loadCaseContainer = document.getElementById('load-case-tbody');
                loadCaseContainer.innerHTML = '';
                data.loadCases.forEach(lc => addLoadCaseRow(lc));
            } else {
                // Setup default state if no saved data
                addLayer('top');
                addLayer('bottom');
                addLoadCaseRow(['LC1', 0, 95.5, 0, 119.4, 0, 80, 0]);
            }
            runBatchAnalysis();
        }

    </script>
</body>
</html>
